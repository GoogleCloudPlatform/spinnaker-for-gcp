# Installing Spinnaker for GCP on Google Cloud Build

## Shared VPC

Please note that using Cloud Build to install Spinnaker for GCP with a Shared VPC host project is currently unsupported. For Shared VPC support, conduct the [setup](https://cloud.google.com/docs/ci-cd/spinnaker/spinnaker-for-gcp) in Cloud Shell.

## Service account

Google Cloud Build has a default service account that can be found in the settings page of the Cloud Build UI. The Cloud Build service account must be configured with the following roles to install Spinnaker for GCP:

- Cloud Functions Developer - roles/cloudfunctions.developer
- Compute Network Viewer - roles/compute.networkViewer
- Kubernetes Engine Admin - roles/container.admin 
- Create Service Accounts - roles/iam.serviceAccountCreator
- Pub/Sub Editor - roles/pubsub.editor
- Cloud Memorystore Redis Admin - roles/redis.admin
- Service Usage Admin - roles/serviceusage.serviceUsageAdmin
- Source Repository Administrator - roles/source.admin
- Storage Admin - roles/storage.admin
- Project IAM Admin - roles/resourcemanager.projectIamAdmin
- Service Account User - roles/iam.serviceAccountUser

These roles can be enabled through the IAM UI or with [gcloud](https://cloud.google.com/sdk/gcloud/reference/projects/add-iam-policy-binding).

## Properties file

In order to install Spinnaker for GCP, you must provide the installation script with a properties file. This properties file can be generated by executing [setup_properties.sh](../scripts/install/setup_properties.sh). Once you have a properties file, it must be provided to the installation script during the execution of the Cloud Build job.

## Submitting a Build

Cloud Builds can be trigged using [gcloud](https://cloud.google.com/cloud-build/docs/running-builds/start-build-manually), [build triggers](https://cloud.google.com/cloud-build/docs/running-builds/automate-builds), or [GitHub app triggers](https://cloud.google.com/cloud-build/docs/create-github-app-triggers). This repository provides the necessary files for installing Spinnaker for GCP with a gcloud triggered build. Follow these steps to start a build:

1. Create a new directory. The contents of this directory will be submitted to Cloud Build.
2. Place the generated properties file into the directory.
3. Copy the [cloudbuild.yaml](cloudbuild.yaml) file into the directory and edit the `user.name` and `user.email` used in the git configuration steps.

```yaml
  - name: gcr.io/cloud-builders/git
    args: ['config', '--global', 'user.name', '<example-user>']
  - name: gcr.io/cloud-builders/git
    args: ['config', '--global', 'user.email', '<example-user@example.com>']
```

4. Copy the [Dockerfile](Dockerfile) and [install.bash](install.bash) file into the directory.
5. Submit the build to Cloud Build: `gcloud builds submit --timeout "25m"  --config cloudbuild.yaml .`

Cloud Build will begin executing the job and installing Spinnaker for GCP. Changes to the properties file can be applied by re-running the job. Additional instructions for how to access or manage the deployed Spinnaker application are available [here](https://cloud.google.com/docs/ci-cd/spinnaker/spinnaker-for-gcp#access_spinnaker).
